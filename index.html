<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>吉他C大调和弦推算工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        .custom-scrollbar::-webkit-scrollbar { height: 8px; width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        /* 禁止背景文字被选中，防止连点时反蓝，提升App体验 */
        .no-select { user-select: none; -webkit-user-select: none; }
    </style>
</head>
<body class="bg-slate-50 no-select">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- 图标组件 ---
        const IconBase = ({ children, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );
        const Trash2 = ({ className }) => (<IconBase className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>);
        const Music = ({ className }) => (<IconBase className={className}><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></IconBase>);
        const CheckCircle = ({ className }) => (<IconBase className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>);
        const RotateCcw = ({ className }) => (<IconBase className={className}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconBase>);
        const Eye = ({ className }) => (<IconBase className={className}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></IconBase>);
        const Settings = ({ className }) => (<IconBase className={className}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconBase>);

        // --- 数据常量 ---
        const CHROMATIC_NOTES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const STRINGS_MIDI = [64, 59, 55, 50, 45, 40]; // E4, B3, G3, D3, A2, E2

        // C大调顺阶和弦定义
        const C_MAJOR_CHORDS = [
            { name: 'C 大调音阶', type: 'scale', intervals: [0, 2, 4, 5, 7, 9, 11], label: 'C Major Scale' },
            { name: 'C',   type: 'chord', intervals: [0, 4, 7],       notes: ['C', 'E', 'G'] },
            { name: 'Dm',  type: 'chord', intervals: [2, 5, 9],       notes: ['D', 'F', 'A'] },
            { name: 'Em',  type: 'chord', intervals: [4, 7, 11],      notes: ['E', 'G', 'B'] },
            { name: 'F',   type: 'chord', intervals: [5, 9, 0],       notes: ['F', 'A', 'C'] },
            { name: 'G',   type: 'chord', intervals: [7, 11, 2],      notes: ['G', 'B', 'D'] },
            { name: 'Am',  type: 'chord', intervals: [9, 0, 4],       notes: ['A', 'C', 'E'] },
            { name: 'Bdim',type: 'chord', intervals: [11, 2, 5],      notes: ['B', 'D', 'F'] },
        ];

        const INTERVAL_MAP = {
            0: '1', 1: '1#', 2: '2', 3: 'b3', 4: '3', 5: '4', 
            6: 'b5', 7: '5', 8: 'b6', 9: '6', 10: 'b7', 11: '7'
        };

        // --- 辅助函数 ---

        const getMidiAtPosition = (stringIndex, fret) => STRINGS_MIDI[stringIndex] + fret;

        const calculateNoteLabel = (midi, displayMode) => {
            const noteIndex = midi % 12;
            
            if (displayMode === 'note') {
                return CHROMATIC_NOTES[noteIndex];
            } else {
                const interval = (noteIndex - 0 + 12) % 12; // C is 0
                const baseChar = INTERVAL_MAP[interval];
                
                const anchorRootMidi = 48; // C3
                const dist = midi - anchorRootMidi;
                const octaveOffset = Math.floor(dist / 12);
                
                let suffix = '';
                if (octaveOffset >= 1) suffix = '.'.repeat(octaveOffset); 
                else if (octaveOffset <= -1) suffix = ','.repeat(Math.abs(octaveOffset)); 
                
                return baseChar + suffix;
            }
        };

        const normalizeJianpu = (val) => {
            if (!val) return '';
            return val.replace(/\+/g, '.').replace(/-/g, ',');
        };

        // --- 组件 ---

        const JianpuNote = ({ value }) => {
            if (!value) return null;
            const baseNote = value.replace(/[.,+\-]/g, '');
            const highCount = (value.match(/[.+]/g) || []).length;
            const lowCount = (value.match(/[,-]/g) || []).length;
            const dotStyle = "w-1 h-1 bg-current rounded-full mx-[1px]";
            return (
                <div className="flex flex-col items-center justify-center leading-none select-none pointer-events-none relative" style={{ minHeight: '1.5em' }}>
                    <div className="flex space-x-[1px] absolute -top-1.5 h-2 items-end">
                        {Array.from({ length: highCount }).map((_, i) => <div key={`h-${i}`} className={dotStyle}></div>)}
                    </div>
                    <div className="font-bold text-base z-10">{baseNote}</div>
                    <div className="flex space-x-[1px] absolute -bottom-1.5 h-2 items-start">
                        {Array.from({ length: lowCount }).map((_, i) => <div key={`l-${i}`} className={dotStyle}></div>)}
                    </div>
                </div>
            );
        };

        const FretCell = ({ 
            s, f, value, onChange, isMarked, isDouble, displayMode, showInlay, 
            checkMode, correctValue, isInScale, isActive, onActivate, onMoveFocus
        }) => {
            const inputRef = useRef(null);

            useEffect(() => {
                if (isActive && inputRef.current) inputRef.current.focus();
            }, [isActive]);

            const handleKeyDown = (e) => {
                const keys = { 'ArrowUp': 'UP', 'ArrowDown': 'DOWN', 'ArrowLeft': 'LEFT', 'ArrowRight': 'RIGHT' };
                if (keys[e.key]) {
                    e.preventDefault();
                    onMoveFocus(keys[e.key]);
                }
            };

            const hasValue = value && value.trim() !== '';
            let statusStyle = '';
            
            if (checkMode) {
                if (hasValue) {
                    const isCorrect = displayMode === 'interval' 
                        ? normalizeJianpu(value) === normalizeJianpu(correctValue)
                        : value.toUpperCase() === correctValue;
                    statusStyle = isCorrect ? 'ring-2 ring-green-500 bg-green-600 text-white' : 'ring-2 ring-red-500 bg-red-100 text-red-600';
                } else if (isInScale) {
                    statusStyle = 'ring-2 ring-yellow-400 border-dashed border-yellow-400 bg-yellow-50';
                }
            } else {
                statusStyle = hasValue ? 'bg-blue-600 text-white shadow-md transform scale-105 hover:bg-blue-700' : 'bg-transparent hover:bg-slate-100 hover:shadow-sm';
            }

            if (isActive) statusStyle = 'bg-white ring-2 ring-blue-500 z-30 shadow-lg';

            return (
                <div className="w-14 relative flex items-center justify-center border-r border-slate-400 shrink-0 h-14 group cursor-pointer">
                    {showInlay && isMarked && (
                        <>
                            {!isDouble && (s === 2 || s === 3) && <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-3 h-3 rounded-full bg-slate-300 opacity-50 pointer-events-none z-0" />}
                            {isDouble && (s === 1 || s === 4) && <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-3 h-3 rounded-full bg-slate-300 opacity-50 pointer-events-none z-0" />}
                        </>
                    )}
                    <div 
                        onClick={(e) => { e.stopPropagation(); onActivate(s, f); }}
                        className={`w-9 h-9 rounded-full flex items-center justify-center transition-all z-20 relative ${statusStyle}`}
                    >
                        {isActive ? (
                            <input
                                ref={inputRef}
                                type="text"
                                value={value || ''}
                                onChange={(e) => onChange(e.target.value)}
                                onKeyDown={handleKeyDown}
                                className="w-full h-full text-center text-sm font-bold focus:outline-none text-slate-900 bg-transparent rounded-full"
                                style={{ color: 'black' }} 
                            />
                        ) : (
                            <div className={`${(hasValue || (checkMode && isInScale && !hasValue)) ? '' : 'text-transparent'}`}>
                                {checkMode && !hasValue && isInScale ? (
                                    <div className="opacity-40 grayscale">
                                        {displayMode === 'interval' ? <JianpuNote value={correctValue} /> : <span className="font-bold text-sm">{correctValue}</span>}
                                    </div>
                                ) : (
                                    displayMode === 'interval' ? <JianpuNote value={value} /> : <span className="font-bold text-sm select-none">{value || '.'}</span>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const GuitarFretboard = () => {
            const [gridData, setGridData] = useState({}); 
            const [selectedTarget, setSelectedTarget] = useState(C_MAJOR_CHORDS[0]); 
            const [displayMode, setDisplayMode] = useState('note'); 
            const [visibleFrets, setVisibleFrets] = useState(12); 
            const [checkMode, setCheckMode] = useState(false);
            const [activeCell, setActiveCell] = useState(null);
            const [autoClear, setAutoClear] = useState(true); 
            const showInlays = true; 

            // 加载/保存
            useEffect(() => {
                const saved = localStorage.getItem('guitar-c-major-data');
                if (saved) { try { setGridData(JSON.parse(saved)); } catch (e) {} }
            }, []);
            useEffect(() => { localStorage.setItem('guitar-c-major-data', JSON.stringify(gridData)); }, [gridData]);

            const correctData = useMemo(() => {
                const data = {};
                for (let s = 0; s < 6; s++) {
                    for (let f = 0; f <= visibleFrets; f++) {
                        const midi = getMidiAtPosition(s, f);
                        const noteIndex = midi % 12;
                        const interval = (noteIndex - 0 + 12) % 12;
                        if (selectedTarget.intervals.includes(interval)) {
                            data[`${s}-${f}`] = calculateNoteLabel(midi, displayMode);
                        }
                    }
                }
                return data;
            }, [selectedTarget, displayMode, visibleFrets]);

            const generateAnswer = () => {
                setGridData(correctData);
                setCheckMode(false);
                setActiveCell(null);
            };

            const handleTargetChange = (item) => {
                setSelectedTarget(item);
                setCheckMode(false);
                if (autoClear) {
                    setGridData({}); 
                }
            };

            const handleCellChange = (s, f, value) => {
                // 自动转大写逻辑：如果是音名模式，转大写；如果是简谱，保持原样
                const finalValue = displayMode === 'note' ? value.toUpperCase() : value;
                setGridData(prev => ({ ...prev, [`${s}-${f}`]: finalValue }));
                if (checkMode) setCheckMode(false);
            };

            const handleActivate = (s, f) => {
                setActiveCell({ s, f });
            };

            const handleMoveFocus = (currentS, currentF, direction) => {
                let newS = currentS, newF = currentF;
                if (direction === 'UP') newS = Math.max(0, currentS - 1);
                else if (direction === 'DOWN') newS = Math.min(5, currentS + 1);
                else if (direction === 'LEFT') newF = Math.max(0, currentF - 1);
                else if (direction === 'RIGHT') newF = Math.min(visibleFrets, currentF + 1);
                setActiveCell({ s: newS, f: newF });
            };

            const isMarkedFret = (fret) => [3, 5, 7, 9, 12, 15, 17, 19, 21, 24].includes(fret);
            const isDoubleMark = (fret) => fret === 12 || fret === 24;

            return (
                <div className="min-h-screen bg-slate-50 p-2 md:p-8 font-sans text-slate-800" onClick={() => setActiveCell(null)}>
                    <div className="max-w-7xl mx-auto space-y-4">
                        
                        {/* 顶部控制面板 - 移除了 stopPropagation */}
                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-4 md:p-6">
                            <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                                <div>
                                    <h1 className="text-2xl font-bold text-slate-900 flex items-center gap-2">
                                        <Music className="w-6 h-6 text-blue-600" />
                                        吉他C大调推算工具
                                    </h1>
                                    <p className="text-slate-500 text-sm mt-1">
                                        点击格子即可填写。切换下方和弦进行针对性练习。
                                    </p>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={(e) => { e.stopPropagation(); setCheckMode(!checkMode); setActiveCell(null); }} className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium border ${checkMode ? 'bg-orange-50 text-orange-600 border-orange-200' : 'bg-white text-slate-600 border-slate-200'}`}>
                                        {checkMode ? <RotateCcw className="w-4 h-4"/> : <CheckCircle className="w-4 h-4" />} {checkMode ? '退出改错' : '检查对错'}
                                    </button>
                                    <button onClick={(e) => { e.stopPropagation(); setGridData({}); setCheckMode(false); setActiveCell(null); }} className="flex items-center gap-2 px-3 py-1.5 bg-red-50 text-red-600 border border-red-100 rounded-lg hover:bg-red-100 text-sm font-medium">
                                        <Trash2 className="w-4 h-4" /> 清空
                                    </button>
                                </div>
                            </div>

                            {/* 控制行 */}
                            <div className="flex flex-col md:flex-row gap-6 border-t border-slate-100 pt-4">
                                {/* 左侧：显示设置 */}
                                <div className="space-y-4 w-full md:w-auto min-w-[200px]">
                                    <div className="space-y-1">
                                        <label className="text-xs font-bold text-slate-400 uppercase tracking-wider">显示模式</label>
                                        <div className="flex bg-slate-100 rounded-lg p-1">
                                            <button onClick={(e) => { e.stopPropagation(); setDisplayMode('note'); }} className={`flex-1 py-1 text-sm font-bold rounded ${displayMode === 'note' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>音名 (C)</button>
                                            <button onClick={(e) => { e.stopPropagation(); setDisplayMode('interval'); }} className={`flex-1 py-1 text-sm font-bold rounded ${displayMode === 'interval' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>简谱 (1)</button>
                                        </div>
                                    </div>
                                    
                                    <div className="space-y-1">
                                        <div className="flex justify-between items-center">
                                            <label className="text-xs font-bold text-slate-400 uppercase tracking-wider">显示品数: {visibleFrets}</label>
                                            <span className="text-xs text-blue-500 font-medium">适合: {visibleFrets <= 5 ? '开放和弦' : '全指板'}</span>
                                        </div>
                                        <input 
                                            type="range" min="3" max="24" step="1" 
                                            value={visibleFrets} 
                                            onChange={(e) => setVisibleFrets(parseInt(e.target.value))}
                                            onClick={(e) => e.stopPropagation()} // 滑块需要阻止冒泡，否则拖动可能触发背景点击
                                            className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
                                        />
                                    </div>

                                    <div className="flex items-center gap-2 pt-2" onClick={(e) => e.stopPropagation()}>
                                        <input 
                                            type="checkbox" id="autoClear" checked={autoClear} onChange={(e) => setAutoClear(e.target.checked)}
                                            className="w-4 h-4 text-blue-600 rounded focus:ring-blue-500 border-gray-300"
                                        />
                                        <label htmlFor="autoClear" className="text-xs text-slate-600 select-none cursor-pointer">切换和弦时自动清空</label>
                                    </div>

                                    <button onClick={(e) => { e.stopPropagation(); generateAnswer(); }} className="w-full py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700 text-sm font-medium shadow-sm flex items-center justify-center gap-2">
                                        <Eye className="w-4 h-4"/> 直接显示答案
                                    </button>
                                </div>

                                {/* 右侧：C大调和弦选择器 */}
                                <div className="flex-1 space-y-1">
                                    <label className="text-xs font-bold text-slate-400 uppercase tracking-wider">切换练习目标 (推算分解和弦)</label>
                                    <div className="grid grid-cols-4 gap-2">
                                        {C_MAJOR_CHORDS.map((item) => (
                                            <button 
                                                key={item.name}
                                                onClick={(e) => { e.stopPropagation(); handleTargetChange(item); }}
                                                className={`py-2 px-1 rounded-lg text-sm font-bold border transition-all relative
                                                    ${selectedTarget.name === item.name 
                                                        ? 'bg-blue-600 text-white border-blue-600 shadow-md ring-2 ring-blue-100' 
                                                        : 'bg-white text-slate-600 border-slate-200 hover:border-blue-300 hover:text-blue-600'
                                                    }
                                                    ${item.type === 'scale' ? 'col-span-4 bg-slate-50' : ''}
                                                `}
                                            >
                                                {item.name}
                                                {item.type === 'chord' && <span className={`block text-[10px] font-normal scale-90 ${selectedTarget.name === item.name ? 'text-blue-100' : 'text-slate-400'}`}>{item.notes.join(' ')}</span>}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* 指板显示区域 - 移除了 stopPropagation */}
                        <div className="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                            <div className="overflow-x-auto pb-6 custom-scrollbar">
                                <div className="inline-block min-w-max p-8">
                                    {/* 顶部数字 */}
                                    <div className="flex mb-2 text-xs font-bold text-slate-400 select-none">
                                        <div className="w-14 text-center"></div> 
                                        {Array.from({ length: visibleFrets }).map((_, i) => (
                                            <div key={i} className="w-14 text-center">{i + 1}</div>
                                        ))}
                                    </div>

                                    {/* 指板 */}
                                    <div className="relative bg-[#fcfaf7] border border-slate-300 rounded-sm shadow-inner select-none flex flex-col w-max">
                                        <div className="absolute inset-0 opacity-5 pointer-events-none bg-orange-50"></div>
                                        {STRINGS_MIDI.map((_, stringIndex) => (
                                            <div key={stringIndex} className="flex h-14 relative border-b border-slate-200 last:border-0 items-center">
                                                {/* 琴弦线 */}
                                                <div className="absolute right-0 top-1/2 -translate-y-1/2 bg-slate-400 pointer-events-none z-0" style={{ left: '3.5rem', height: `${stringIndex * 0.5 + 1}px`, opacity: 0.8 }}></div>
                                                
                                                {/* 0品/空弦 */}
                                                <div className="w-14 relative flex items-center justify-center border-r-4 border-slate-700 bg-blue-50/50 z-10 shrink-0 h-full">
                                                    <FretCell 
                                                        s={stringIndex} f={0} 
                                                        value={gridData[`${stringIndex}-0`]} 
                                                        onChange={(val) => handleCellChange(stringIndex, 0, val)}
                                                        displayMode={displayMode} showInlay={false}
                                                        checkMode={checkMode} correctValue={correctData[`${stringIndex}-0`]} isInScale={!!correctData[`${stringIndex}-0`]}
                                                        isActive={activeCell?.s === stringIndex && activeCell?.f === 0}
                                                        onActivate={handleActivate} onMoveFocus={(dir) => handleMoveFocus(stringIndex, 0, dir)}
                                                    />
                                                </div>

                                                {/* 1-N品 */}
                                                {Array.from({ length: visibleFrets }).map((_, fretIndex) => {
                                                    const actualFret = fretIndex + 1;
                                                    const key = `${stringIndex}-${actualFret}`;
                                                    return (
                                                        <FretCell 
                                                            key={actualFret}
                                                            s={stringIndex} f={actualFret}
                                                            value={gridData[key]} 
                                                            onChange={(val) => handleCellChange(stringIndex, actualFret, val)}
                                                            isMarked={isMarkedFret(actualFret)} isDouble={isDoubleMark(actualFret)}
                                                            displayMode={displayMode} showInlay={showInlays}
                                                            checkMode={checkMode} correctValue={correctData[key]} isInScale={!!correctData[key]}
                                                            isActive={activeCell?.s === stringIndex && activeCell?.f === actualFret}
                                                            onActivate={handleActivate} onMoveFocus={(dir) => handleMoveFocus(stringIndex, actualFret, dir)}
                                                        />
                                                    );
                                                })}
                                            </div>
                                        ))}
                                    </div>

                                    {/* 底部数字 */}
                                    <div className="flex mt-2 text-xs font-bold text-slate-400 select-none">
                                        <div className="w-14 text-center"></div>
                                        {Array.from({ length: visibleFrets }).map((_, i) => (
                                            <div key={i} className="w-14 text-center">{i + 1}</div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<GuitarFretboard />);
    </script>
</body>
</html>
